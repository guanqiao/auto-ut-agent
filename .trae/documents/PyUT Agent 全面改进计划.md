# PyUT Agent 全面改进计划

## 计划概述

本计划包含 26 个改进任务，分为 4 个优先级阶段，涵盖代码重构、内存安全、并发安全、测试覆盖、代码清理等方面。

---

## 阶段 1：P0 - 紧急重构（8个任务）

### 上帝类拆分
1. **拆分 ReActAgent - 提取 CompilationHandler**
   - 将编译相关逻辑从 ReActAgent 中提取到独立的 CompilationHandler 类
   - 目标：降低 ReActAgent 复杂度

2. **拆分 ReActAgent - 提取 TestExecutionHandler**
   - 将测试执行相关逻辑提取到 TestExecutionHandler 类
   - 目标：单一职责原则

3. **拆分 ReActAgent - 提取 CoverageAnalyzer**
   - 将覆盖率分析逻辑提取到 CoverageAnalyzer 类
   - 目标：提高可测试性

4. **拆分 TestGeneratorAgent 上帝类**
   - 拆分测试生成和 Aider 集成逻辑
   - 目标：降低类复杂度

### 超长函数重构
5. **重构 run_feedback_loop() 超长函数（160+行）**
   - 拆分为多个小函数，每个函数 < 50 行
   - 使用状态模式管理状态转换

6. **重构 generate_tests_with_aider() 超长函数（190+行）**
   - 提取迭代优化逻辑到独立方法
   - 目标：降低圈复杂度

7. **重构 _attempt_fix() 超长函数（110+行）**
   - 拆分多种修复策略到独立方法
   - 目标：提高可读性

8. **重构 _execute_with_recovery() 高复杂度函数**
   - 简化嵌套的 try-except 块
   - 提取错误处理逻辑

---

## 阶段 2：P1 - 高风险修复（7个任务）

### 内存泄漏修复
9. **修复 StatePreserver 内存泄漏风险**
   - 添加历史记录大小限制
   - 实现自动清理机制

10. **修复 vector_store.py SQLite 连接泄漏**
    - 确保所有路径都正确关闭连接
    - 使用上下文管理器模式

### 并发安全修复
11. **修复 react_agent.py 停止标志线程安全问题**
    - 将 `self._stop_requested = False` 改为 `threading.Event()`
    - 确保线程安全

12. **修复 batch_generator.py 并发安全问题**
    - 添加适当的锁保护
    - 使用原子操作

### 测试覆盖
13. **为 ReActAgent 添加单元测试**
    - 覆盖主要业务流程
    - 使用 Mock 隔离依赖

14. **为 ErrorRecoveryManager 添加单元测试**
    - 测试错误分类和恢复策略
    - 测试边界情况

15. **为 BatchGenerator 添加单元测试**
    - 测试批量生成功能
    - 测试并发控制

---

## 阶段 3：P2 - 代码质量（6个任务）

### 重复代码清理
16. **提取重复的 _extract_java_code 方法到公共模块**
    - 创建 shared/utils.py 模块
    - 统一代码提取逻辑

### 死代码移除
17. **移除 _fix_multi_file 死代码**
    - 删除未实现的多文件编辑功能
    - 清理相关引用

18. **移除未使用的 SCOPED 生命周期**
    - 从 container.py 中移除
    - 更新相关文档

19. **清理未使用的导入（numpy等）**
    - 扫描所有文件的未使用导入
    - 统一清理

### 依赖优化
20. **解决 tenacity 和 backoff 依赖冗余**
    - 评估后保留一个
    - 统一重试逻辑

21. **解决 agent/tools/core 循环依赖**
    - 引入接口层解耦
    - 优化模块结构

---

## 阶段 4：P3 - 完善优化（5个任务）

### 资源管理
22. **完善文件操作资源释放 - 使用上下文管理器**
    - 统一使用 `with` 语句
    - 添加异常处理

23. **细化异常处理 - 避免裸 except Exception**
    - 捕获具体异常类型
    - 添加详细错误日志

### 项目配置
24. **添加 .gitignore 文件**
    - Python 项目标准配置
    - 排除敏感文件和临时文件

### 代码规范
25. **统一日志语言为英文**
    - 替换所有中文日志
    - 便于国际化

26. **完善类型注解**
    - 为所有公共 API 添加类型注解
    - 使用 mypy 检查

---

## 执行顺序建议

```
阶段 1 (P0) → 阶段 2 (P1) → 阶段 3 (P2) → 阶段 4 (P3)
   ↓              ↓              ↓              ↓
 8个任务       7个任务        6个任务        5个任务
```

每个阶段完成后建议运行测试确保稳定性。

---

## 预期收益

1. **可维护性**：上帝类拆分后，代码更易理解和维护
2. **稳定性**：修复内存泄漏和并发安全问题
3. **可靠性**：测试覆盖率提升，减少回归风险
4. **性能**：资源管理优化，减少资源泄漏
5. **规范性**：代码风格统一，符合 Python 最佳实践

---

## 风险评估

- **高风险**：P0 阶段重构可能引入回归，需要充分测试
- **中风险**：P1 阶段并发修改需要仔细验证
- **低风险**：P2/P3 阶段主要是清理工作，风险较低

建议每个阶段完成后进行代码审查和测试验证。