## 功能概述

为 CLI 和 GUI 添加一键生成项目所有 Java 文件测试代码的功能，支持**并行生成**，同时提高容错性、可观测性和可操作性。

***

## 实现步骤

### 第一阶段：编写测试用例 (TDD)

1. **创建** `tests/cli/test_generate_all_command.py`
   - 测试 `generate-all` 命令帮助信息
   - 测试扫描项目并返回文件列表
   - 测试批量生成逻辑
   - 测试容错机制（单个文件失败不影响其他文件）
   - 测试进度报告
   - **测试并行配置参数**
   - **测试并行执行逻辑**

### 第二阶段：实现核心批量生成服务

1. **创建** `pyutagent/services/batch_generator.py`
   - `BatchGenerator` 类：负责批量生成测试
   - `BatchConfig` 数据类：配置参数（并行数、超时等）
   - `BatchProgress` 数据类：跟踪进度状态
   - `BatchResult` 数据类：汇总结果
   - **并行执行：使用 `asyncio.Semaphore` 控制并发数**
   - 容错机制：单个文件失败时记录错误并继续
   - 进度回调：支持实时进度更新

### 第三阶段：实现 CLI 命令

1. **创建** `pyutagent/cli/commands/generate_all.py`
   - `generate-all` 命令：扫描项目并批量生成
   - 参数：
     - `--project-path`: 项目路径
     - `--llm`: LLM 配置
     - `--coverage-target`: 覆盖率目标
     - `--max-iterations`: 最大迭代次数
     - `--continue-on-error`: 错误时继续
     - **`--parallel / -p`: 并行数（默认 1，0 表示不限制）**
     - **`--timeout`: 单文件超时时间（秒）**
   - Rich 进度条显示
   - 实时状态更新

2. **更新** `pyutagent/cli/main.py`
   - 注册 `generate-all` 命令

### 第四阶段：实现 GUI 功能

1. **创建** `pyutagent/ui/batch_generate_dialog.py`
   - 批量生成对话框
   - 文件列表显示（可勾选）
   - **并行数配置输入框**
   - 进度显示
   - 结果汇总表格
   - 暂停/继续/停止按钮

2. **更新** `pyutagent/ui/main_window.py`
   - 添加菜单项 "Generate All Tests"
   - 添加工具栏按钮
   - 连接批量生成对话框

### 第五阶段：提高可观测性

1. **增强进度报告**
   - CLI: 使用 Rich Live 显示实时进度表格
   - GUI: 进度条 + 状态表格 + 日志区域
   - 每个文件显示：状态、覆盖率、迭代次数、错误信息

### 第六阶段：运行测试验证

1. **运行测试**
   - `pytest tests/cli/test_generate_all_command.py`
   - `pytest tests/` 确保不破坏现有功能

***

## 文件变更清单

| 操作 | 文件路径 |
|------|----------|
| 新建 | `tests/cli/test_generate_all_command.py` |
| 新建 | `pyutagent/services/__init__.py` |
| 新建 | `pyutagent/services/batch_generator.py` |
| 新建 | `pyutagent/cli/commands/generate_all.py` |
| 新建 | `pyutagent/ui/batch_generate_dialog.py` |
| 修改 | `pyutagent/cli/main.py` |
| 修改 | `pyutagent/cli/commands/__init__.py` |
| 修改 | `pyutagent/ui/main_window.py` |

***

## 并行执行设计

```python
class BatchConfig:
    parallel_workers: int = 1  # 并行数，0 表示不限制
    timeout_per_file: int = 300  # 单文件超时（秒）
    continue_on_error: bool = True  # 错误时继续

async def generate_all(self, files: List[str]) -> BatchResult:
    semaphore = asyncio.Semaphore(
        self.config.parallel_workers if self.config.parallel_workers > 0 
        else len(files)
    )
    
    async def generate_with_limit(file):
        async with semaphore:
            return await self._generate_single(file)
    
    tasks = [generate_with_limit(f) for f in files]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    return self._aggregate_results(results)
```

***

## CLI 使用示例

```bash
# 串行执行（默认）
pyutagent-cli generate-all /path/to/project

# 4 个并行 worker
pyutagent-cli generate-all /path/to/project --parallel 4

# 不限制并行数（慎用）
pyutagent-cli generate-all /path/to/project --parallel 0

# 配置超时
pyutagent-cli generate-all /path/to/project -p 4 --timeout 600
```

***

## 可观测性设计

**CLI 输出示例：**

```
╭─────────────────────────────────────────────────────────────╮
│ Batch Test Generation Progress (Parallel: 4)                │
├─────────────────────────────────────────────────────────────┤
│ [████████████░░░░░░░░] 60% (6/10 files)                    │
├─────────────────────────────────────────────────────────────┤
│ File                    Status    Coverage  Iters  Time     │
│ UserService.java        ✓ Done    85%       3      12.3s   │
│ OrderService.java       ✓ Done    92%       2      8.5s    │
│ ProductService.java     ✗ Failed  -         -      5.2s    │
│ PaymentService.java     ⏳ Gen...  -         -      -       │
│ InventoryService.java   ⏳ Comp... -         -      -       │
│ ReportService.java      ⏳ Test... -         -      -       │
│ ...                                                        │
╰─────────────────────────────────────────────────────────────╯
```