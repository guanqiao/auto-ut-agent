# PyUT Agent 架构重构计划

## 阶段一：清理冗余代码（高优先级）

### 1. 统一 AgentState 和 AgentResult 定义
- 删除 `agent/base_agent.py` 中的重复定义
- 统一使用 `core/protocols.py` 中的定义
- 更新所有导入引用

### 2. 删除 deprecated 代理文件
- 删除 `agent/retry_manager.py`
- 删除 `tools/retry_manager.py`
- 删除 `agent/error_recovery.py`
- 删除 `tools/error_recovery.py`
- 更新 `agent/__init__.py` 和相关导入

---

## 阶段二：拆分 ReActAgent（高优先级）

### 3. 创建服务层架构
```
agent/
├── services/
│   ├── __init__.py
│   ├── compilation_service.py    # 编译服务
│   ├── test_execution_service.py # 测试执行服务
│   ├── coverage_service.py       # 覆盖率分析服务
│   └── test_generation_service.py # 测试生成服务
├── react_agent.py (精简版，仅编排逻辑)
```

---

## 阶段三：架构优化（中优先级）

### 4. 封装全局状态到 ApplicationContext
```python
# core/context.py
class ApplicationContext:
    def __init__(self):
        self._settings: Optional[Settings] = None
        self._container: Optional[Container] = None
        self._file_cache: Optional[FileCache] = None
        self._retry_manager: Optional[RetryManager] = None
```

### 5. Protocol 依赖注入改造
- `ReActAgent` 改用 `LLMClientProtocol` 而非具体实现
- 创建 `JavaParserProtocol` 并应用于相关类
- 更新 Container 注册使用 Protocol 类型

### 6. 引入事件系统
```python
# core/events.py
class AgentEvent: ...
class EventEmitter: ...
class EventSubscriber: ...
```

---

## 阶段四：模块结构优化（低优先级）

### 7. 优化 tools 模块结构
- 按功能分组：`tools/maven/`, `tools/editors/`, `tools/parsers/`
- 统一接口命名规范

---

## 执行顺序
1. 阶段一（无依赖风险）
2. 阶段二（依赖阶段一完成）
3. 阶段三（依赖阶段二完成）
4. 阶段四（可独立进行）